<?php		$this->load_langfile('inside/global.php');	$this->load_langfile('outside/contacts.php');		$D->page_title	= $this->lang('contacts_pgtitle', array('#SITE_TITLE#'=>$C->SITE_TITLE));		$D->submit	= FALSE;	$D->error	= FALSE;	$D->errmsg	= '';	$D->sabad=false;	$D->pay=false;	$D->baste=array();	include_once('helpers/nusoap.php');		$D->tabs = array('sabad','pay','submit');	if(!in_array($this->param('tab'),$D->tabs)){$this->redirect('dashboard');	}	if(isset($_POST['payfs']) && isset($_POST['fp_select']) && $this->param('tab') == "sabad"){		if($db2->fetch_field('SELECT COUNT(id) FROM users_ifllow_pay WHERE user_id="'.$this->user->id.'" LIMIT 1') > 0){	$D->error = true;	$D->errmsg .= 'شما یک بسته خریدید تا موعود سر رسید نمی توانید خریداری کنید <a href="'.$C->SITE_URL.'" >برگشت</a>';	$this->load_template('payfllow.php');	return;	}	$D->sabad=true;	 $a= $_POST['fp_select'];    $it = 'FLLOW_M'.$a;	$D->baste= array( 'amount'=> $C->$it ,'pri'=>$a  );$this->user->sess['PAY_FOLLOW_ZARIN'] = $D->baste;	}	elseif(isset($_POST['pardakht']) && isset($_POST['pri_2']) && $s = $this->user->sess['PAY_FOLLOW_ZARIN'] && isset($_POST['amount_2']) && $this->param('tab') == "submit"){	$D->baste = false;	$D->sabad=false;	 $amount= $_POST['amount_2'];	 $pri= $_POST['pri_2'];     $it = 'FLLOW_M'.$pri;   	$MerchantID = 'XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX';	$Amount = ($_POST['amount_2']); //Amount will be based on Toman  - Required	$Description = 'خرید آگهی دنبالم کن';  // Required	$Email = $this->user->info->email; // Optional	$Mobile =''; // Optional	$CallbackURL = $C->SITE_URL.'payfllow/tab:pay/'; // Required			// URL also Can be https://ir.zarinpal.com/pg/services/WebGate/wsdl	$client = new nusoap_client('https://de.zarinpal.com/pg/services/WebGate/wsdl', 'wsdl'); 	$client->soap_defencoding = 'UTF-8';	$result = $client->call('PaymentRequest', array(													array(															'MerchantID' 	=> $MerchantID,															'Amount' 		=> $Amount,															'Description' 	=> $Description,															'Email' 		=> $Email,															'Mobile' 		=> $Mobile,															'CallbackURL' 	=> $CallbackURL														)													)	);	//Redirect to URL You can do it also by creating a form	if($result['Status'] == 100)	{	$this->user->sess['FOLLOW_ALLOW_SESSION'] = $result['Authority'];$this->user->sess[$result['Authority']] = $this->user->sess['PAY_FOLLOW_ZARIN'];unset($this->user->sess['PAY_FOLLOW_ZARIN']);		$this->redirect('https://www.zarinpal.com/pg/StartPay/'.$result['Authority']);			} else {		echo'ERR: '.$result['Status'];	}	}elseif(isset($_GET['Authority']) && isset($this->user->sess['FOLLOW_ALLOW_SESSION']) && $_GET['Authority'] == $this->user->sess['FOLLOW_ALLOW_SESSION']){	$MerchantID = 'XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'; $Authority = $this->user->sess['FOLLOW_ALLOW_SESSION']; $au =$Authority;$basteha = $this->user->sess[$au];$Amount = $amount =	$basteha['amount'];$pri = 	$basteha['pri']; $trak = 	'';//$_GET['refID'];$client = new nusoap_client('https://de.zarinpal.com/pg/services/WebGate/wsdl', 'wsdl'); 		$client->soap_defencoding = 'UTF-8';		$result = $client->call('PaymentVerification', array(															array(																	'MerchantID'	 => $MerchantID,																	'Authority' 	 => $Authority,																	'Amount'	 	 => $Amount																)															)		);				if(trim($result['Status']) !== '100'){			echo 'ERR';			return;		}$trak = $result['RefID'];$time= time();$priud = $pri * 60 * 60 * 24 * 30;$next_time = $time+$priud;$db2->query('INSERT INTO users_ifllow_pay  SET baste="'.$pri.'",user_id="'.$this->user->id.'", date="'.$time.'",next_date="'.$next_time.'", trak="'.$trak.'"');unset($this->user->sess[$au]);unset($this->user->sess['FOLLOW_ALLOW_SESSION']);$this->redirect('payfllow');}else{$this->redirect('dashboard');}		$this->load_template('payfllow.php');	?>